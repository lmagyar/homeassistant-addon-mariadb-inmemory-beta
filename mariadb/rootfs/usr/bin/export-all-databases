#!/command/with-contenv bashio
# shellcheck shell=bash
# ==============================================================================
# Export all databases
# ==============================================================================

# do not use bashio functions, during shutdown they won't return true!
if [[ "${EXPORT_IMPORT_ALL_DATABASES_CONTENT}" == "true" ]]; then
    # EXPORT_STARTED_TIMESTAMP is used by the healthcheck script
    printf "$(date +"%s")" > /var/run/s6/container_environment/EXPORT_STARTED_TIMESTAMP

    # mutually exclusive lock with healthcheck
    # if healthcheck runs during export, "flush tables with read lock" makes it fail, and the server will be restarted immediately, ie. during export
    s6-setlock -t 30000 /tmp/export-lock /usr/bin/export-all-databases-worker
fi
