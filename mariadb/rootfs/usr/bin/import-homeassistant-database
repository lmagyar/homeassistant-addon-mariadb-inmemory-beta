#!/command/with-contenv bashio
# ==============================================================================
# Import homeassistant database content
# ==============================================================================
MARIADB_DATA=$(</etc/MARIADB_DATA)
MARIADB_DUMP=$(</etc/MARIADB_DUMP)

if bashio::config.exists "retention.enabled" && bashio::fs.directory_exists "${MARIADB_DATA}/homeassistant"; then
    if bashio::config.true "retention.enabled"; then
        if ! bashio::fs.file_exists "${MARIADB_DUMP}"; then
            bashio::log.warning "Importing last known databases content skipped, no dump file found"
        else
            bashio::log.info "Last known database content time stamp is $(stat ${MARIADB_DUMP} -c %y)"
            bashio::log.info "Importing database content..."
            gzip -d ${MARIADB_DUMP} -c | mysql homeassistant
        fi
    else
        if bashio::fs.file_exists "${MARIADB_DUMP}"; then
            rm ${MARIADB_DUMP}
            bashio::log.info "Data retention is explicitly turned off, unused exported database content is removed"
        fi
    fi
fi
