#!/command/with-contenv bashio
# ==============================================================================
# Export homeassistant database
# ==============================================================================
MARIADB_DUMP=$(</etc/MARIADB_DUMP)
MARIADB_DUMP_FINISHED=$(</etc/MARIADB_DUMP_FINISHED)
EXPORT_IMPORT_DATABASE_CONTENT=$(</etc/EXPORT_IMPORT_DATABASE_CONTENT)

# remove $2 list from $1 list, modifies $1 list, pass arguments by name
function remove() {
    local -n list=${1}
    local -n list_to_remove=${2}
    local new_list=()
    for item in "${list[@]}"; do [[ " ${list_to_remove[@]} " =~ " ${item} " ]] || new_list+=("${item}"); done
    list=("${new_list[@]}")
}

# do not use bashio functions, during shutdown they won't return true!
if [[ "${EXPORT_IMPORT_DATABASE_CONTENT}" = "true" ]]; then
    exec 4> >(mysql)
    echo "FLUSH TABLES WITH READ LOCK;" >&4
    bashio::log.info "MariaDB tables locked"

    bashio::log.info "Exporting database structure and content"

    # collect all table names
    declare -a tables=()
    for table in $(mysql homeassistant -Nse 'SELECT `table_name` FROM `information_schema`.`tables` WHERE `table_schema`="homeassistant";' 2> /dev/null); do
        tables+=("${table}")
    done
    declare -a tables_to_dump=()

    # dump schema
    mysqldump homeassistant --no-data \
            --skip-lock-tables --skip-add-drop-table \
        | gzip -9 > ${MARIADB_DUMP/TYPE/schema}.tmp

    # dump tables to be imported first
    tables_to_dump=("schema_changes" "recorder_runs" "statistics_meta" "statistics_runs")
    remove tables tables_to_dump
    mysqldump homeassistant $(printf '%s ' "${tables_to_dump[@]}") \
            --skip-lock-tables --skip-add-drop-table --no-create-info --skip-add-locks --complete-insert --insert-ignore \
        | gzip -9 > ${MARIADB_DUMP/TYPE/data1}.tmp

    # dump tables to be imported next, it also dumps any new table that is unknown for this script
    tables_to_dump=("statistics_short_term" "statistics" "state_attributes" "states" "event_data" "events")
    remove tables tables_to_dump
    mysqldump homeassistant $(printf '%s ' "${tables_to_dump[@]}") $(printf '%s ' "${tables[@]}") \
            --skip-lock-tables --skip-add-drop-table --no-create-info --skip-add-locks --complete-insert --insert-ignore \
        | gzip -9 > ${MARIADB_DUMP/TYPE/data2}.tmp

    # replace old exported data in atomic way
    touch ${MARIADB_DUMP_FINISHED}
    rm -f ${MARIADB_DUMP/TYPE/schema}
    rm -f ${MARIADB_DUMP/TYPE/data1}
    rm -f ${MARIADB_DUMP/TYPE/data2}
    mv ${MARIADB_DUMP/TYPE/schema}.tmp ${MARIADB_DUMP/TYPE/schema}
    mv ${MARIADB_DUMP/TYPE/data1}.tmp ${MARIADB_DUMP/TYPE/data1}
    mv ${MARIADB_DUMP/TYPE/data2}.tmp ${MARIADB_DUMP/TYPE/data2}
    rm ${MARIADB_DUMP_FINISHED}

    echo "UNLOCK TABLES;" >&4
    bashio::log.info "MariaDB tables unlocked"
    exec 4>&-
fi
