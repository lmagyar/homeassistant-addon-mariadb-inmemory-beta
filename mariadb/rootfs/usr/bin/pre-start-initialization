#!/command/with-contenv bashio
# ==============================================================================
# Pre-start initialization of MariaDB service
# ==============================================================================
TMPFS_MNT=/tmp
MARIADB_DATA=${TMPFS_MNT}/databases
MARIADB_DUMP=/data/homeassistant-database-dump.sql.gz
NEW_INSTALL=false

# Change tmpfs size to configured value
TMPFS_SIZE=$(bashio::config "tmpfs.size")
bashio::log.info "Change tmpfs size to ${TMPFS_SIZE}"
mount -o remount,size=${TMPFS_SIZE} tmpfs ${TMPFS_MNT}

# Init mariadb
if ! bashio::fs.directory_exists "${MARIADB_DATA}"; then
    bashio::log.info "Create a new mariadb initial system"
    mysql_install_db --user=root --datadir="${MARIADB_DATA}" --skip-name-resolve --skip-test-db > /dev/null
    NEW_INSTALL=true
else
    bashio::log.info "Using existing mariadb initial system"
fi

# Redirect log output
rm -f "${MARIADB_DATA}/mariadb.err"
ln -s /proc/1/fd/1 "${MARIADB_DATA}/mariadb.err"

# Save variables
echo ${MARIADB_DATA} > /etc/MARIADB_DATA
echo ${MARIADB_DUMP} > /etc/MARIADB_DUMP
echo ${NEW_INSTALL} > /etc/NEW_INSTALL
